# Grid On/Off Toggle Fix
**Date**: 2025-12-02 00:30
**Status**: ‚úÖ COMPLETE

## Problem

Grid was not turning on/off correctly:
- Turning grid OFF worked (disposed properly)
- Turning grid ON after being off did nothing (grid stayed invisible)
- Settings were applied in wrong order

## Root Cause

1. **Grid Not Recreated**: When `setGridVisible(true)` was called after grid was disposed, the grid helper was `null` and never recreated
2. **Settings Applied Before Visibility**: Grid size/opacity/plane were only applied if grid was visible, but then visibility was set after, creating a timing issue

## Solution

### 1. Auto-Recreate Grid (Lines 481-527 in ThreeRenderer.js)

**Updated `setGridVisible(visible)` to recreate grid when needed**:

```javascript
if (visible) {
    if (this.gridHelper) {
        // Grid exists - just show it
        this.gridHelper.visible = true;
    } else {
        // Grid doesn't exist - recreate it with current settings
        const size = this.gridSize || 10;
        const divisions = 50;
        const totalSize = size * divisions;
        const gridColor = window.darkModeEnabled ? 0x444444 : 0xcccccc;
        
        this.gridHelper = new THREE.GridHelper(totalSize, divisions, gridColor, gridColor);
        
        // Apply grid plane orientation
        const gridPlane = this.gridPlane || "XY";
        this.applyGridPlaneOrientation(gridPlane);
        
        // Position grid at data centroid
        this.gridHelper.position.set(
            this.orbitCenterX || 0, 
            this.orbitCenterY || 0, 
            this.orbitCenterZ || 0
        );
        
        // Apply current opacity
        if (this.gridOpacity !== undefined) {
            this.gridHelper.material.opacity = this.gridOpacity;
            this.gridHelper.material.transparent = true;
        }
        
        this.scene.add(this.gridHelper);
    }
}
```

### 2. Store Settings Even When Grid Off (Lines 529-588 in ThreeRenderer.js)

**Updated `updateGridSize()` to only modify if grid exists**:

```javascript
updateGridSize(size) {
    // Store grid size
    this.gridSize = size;
    
    // Only update if grid exists
    if (!this.gridHelper) {
        console.log("üìê Grid size stored (grid not created yet)");
        return;
    }
    
    // Recreate grid with new size...
}
```

**Same pattern for `updateGridOpacity()` and `updateGridPlane()`**

### 3. Fix Settings Application Order (Lines 43796-43833 in kirra.js)

**Changed order in `apply3DSettings()`**:

**Before**:
```javascript
// 1. Set visibility (may dispose grid)
setGridVisible(settings.showGrid);
// 2. Set size (if visible) - but grid might be null!
updateGridSize(settings.gridSize);
```

**After**:
```javascript
// 1. Store grid size (doesn't create grid)
updateGridSize(settings.gridSize);
// 2. Store grid opacity (doesn't create grid)
updateGridOpacity(settings.gridOpacity);
// 3. Store grid plane (doesn't create grid)
updateGridPlane(settings.gridPlane);
// 4. Set visibility LAST (creates grid with correct settings)
setGridVisible(settings.showGrid);
```

## Benefits

1. **Grid Always Works**: Toggling on/off now works reliably
2. **Settings Preserved**: Grid size, opacity, and plane orientation persist when toggling off/on
3. **Memory Efficient**: Grid is still properly disposed when off (no memory leak)
4. **Correct Creation**: When recreated, grid uses all stored settings immediately

## How It Works

### Turning Grid OFF:
1. User unchecks "Show Grid"
2. `setGridVisible(false)` is called
3. Grid geometry and material are disposed
4. Grid is removed from scene
5. `this.gridHelper = null`
6. **Settings remain stored** (`gridSize`, `gridOpacity`, `gridPlane`)

### Turning Grid ON:
1. User checks "Show Grid"
2. `setGridVisible(true)` is called
3. Checks if `this.gridHelper` exists
4. If null, creates new grid using stored settings:
   - Uses `this.gridSize` for size
   - Uses `this.gridPlane` for orientation
   - Uses `this.gridOpacity` for transparency
   - Uses `this.orbitCenterX/Y/Z` for position
5. Adds grid to scene
6. Grid appears with correct settings

## Testing

Tested scenarios:
1. ‚úÖ Turn grid off ‚Üí Turn grid on (works)
2. ‚úÖ Change settings while off ‚Üí Turn on (applies settings)
3. ‚úÖ Toggle multiple times (no memory leak)
4. ‚úÖ Change size while on (updates immediately)
5. ‚úÖ Change plane while on (updates immediately)

## Files Modified

1. **src/three/ThreeRenderer.js**
   - Lines 481-527: Enhanced `setGridVisible()` with auto-recreation
   - Lines 529-548: Updated `updateGridSize()` to store settings
   - Lines 550-562: Updated `updateGridOpacity()` to store settings
   - Lines 564-576: Updated `updateGridPlane()` to store settings

2. **src/kirra.js**
   - Lines 43796-43833: Reordered settings application in `apply3DSettings()`

## Known Limitations

None - grid on/off now works correctly in all tested scenarios.

---

**Implemented by**: AI Assistant  
**Date**: 2025-12-02  
**Related to**: 20251202-0000-GridAndClippingEnhancements.md





