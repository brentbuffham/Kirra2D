# 3D Mode Quirks - Fixed

**Date:** 2025-11-25 14:45  
**File:** src/kirra.js

## Summary

Fixed three quirks in 3D mode operation and one undeclared variable error.

---

## Issues Fixed

### 1. Undeclared Variable Error

**Location:** Line ~2873 (resetFloatingToolbarButtons function)  
**Error:** `Uncaught ReferenceError: assignment to undeclared variable isAddKADPointsToolActive`

**Root Cause:**  
Variable was declared as `isAddKADPointsToolActive` (line 2250) but referenced as `isAddKADPointToolActive` (with 's')

**Fix:**  
Changed line 2873 from:

```javascript
isAddKADPointToolActive = excluding === "addKADPointsTool";
```

to:

```javascript
isAddKADPointsToolActive = excluding === "addKADPointsTool";
```

---

### 2. QUIRK 1: Jerkiness on 3D Startup

**Symptoms:**

-   App starts in 3D mode successfully
-   Once data loads, interface becomes jerky/laggy
-   Workaround: Switch to 2D → Drag scene → Switch back to 3D → Now smooth

**Root Cause:**  
CameraControls animation loop only started when user-generated velocity was created (drag/orbit/rotate). On startup, the loop wasn't running, causing:

-   Scene only rendered on specific events (not continuously)
-   Mouse movements triggered individual render calls without smooth animation
-   Dragging in 2D initialized the momentum system, which carried over to 3D

**Fix (Line ~567):**  
Added immediate animation loop start after CameraControls initialization:

```javascript
// Step 6a.1) START ANIMATION LOOP IMMEDIATELY for smooth 3D rendering
// This ensures the scene renders continuously even without user interaction
// Fixes QUIRK 1: Jerkiness on startup until user drags 2D then returns to 3D
if (cameraControls.animationFrameId === null) {
    cameraControls.animationFrameId = requestAnimationFrame(cameraControls.animate);
    console.log("✅ Started CameraControls animation loop for smooth 3D rendering");
}
```

---

### 3. QUIRK 2: Select Pointer Not Active on Startup

**Symptoms:**

-   Select Pointer tool not active on startup
-   User can still select holes by clicking
-   Selection should only work when Select Pointer tool button is pressed

**Root Cause:**  
The `handle3DClick()` function checked radio button state (Holes vs KAD) but did NOT check if `isSelectionPointerActive` was true. This allowed selection to occur even when no tool was active.

**Fix (Line ~877):**  
Added tool activation check before allowing selection:

```javascript
// Step 12h.5a) Only allow selection if SelectPointer tool is active OR a connector tool is active
// Fixes QUIRK 2: Prevent selection when no tool is active
const isConnectorToolActive = isAddingConnector || isAddingMultiConnector;
if (!isSelectionPointerActive && !isConnectorToolActive && !isMultiHoleSelectionEnabled) {
    console.log("⏭️ [3D CLICK] Select Pointer tool not active - skipping selection");
    return;
}
```

---

### 4. QUIRK 3: SelectPolygon and SelectPointer Don't Turn Each Other Off in 3D

**Symptoms:**

-   In 3D mode, clicking SelectPolygon doesn't deactivate SelectPointer
-   SelectPointer doesn't deactivate SelectPolygon
-   Both tools can appear active simultaneously
-   Note: Deactivating tools should NOT remove existing selections

**Root Cause:**  
Two issues identified:

1. **selectByPolygonTool** (line 26311): In 3D mode, it enabled polygon selection but returned early, skipping the `resetFloatingToolbarButtons()` call that would uncheck SelectPointer

2. **selectPointerTool** (line 25015): When activated, it didn't check for or disable 3D polygon selection

**Fix 1 (Line ~26317):**  
Added mutual exclusion for 3D polygon selection:

```javascript
// Step 1a.1) Reset other tool buttons (mutual exclusion)
// Fixes QUIRK 3: SelectPointer and SelectPolygon should turn each other off
resetFloatingToolbarButtons("selectByPolygonTool");

// Step 1a.2) Explicitly disable Select Pointer tool
isSelectionPointerActive = false;
selectPointerTool.checked = false;
```

**Fix 2 (Line ~25023):**  
Added 3D polygon selection disable when SelectPointer activates:

```javascript
// Step X) Disable 3D polygon selection if active
// Fixes QUIRK 3: SelectPointer and SelectPolygon should turn each other off
if (onlyShowThreeJS && window.polygonSelection3D) {
    window.polygonSelection3D.disable();
    selectByPolygonTool.checked = false;
    console.log("✅ Disabled 3D polygon selection (SelectPointer activated)");
}
```

---

## Testing Checklist

### QUIRK 1 - Animation Loop

-   [ ] Start app in 3D mode
-   [ ] Load data
-   [ ] Verify camera orbit/rotate is smooth immediately (no jerkiness)
-   [ ] No need to switch to 2D and back

### QUIRK 2 - Selection Tool Activation

-   [ ] Start app (no tool active)
-   [ ] Try clicking holes - should NOT select
-   [ ] Activate Select Pointer tool
-   [ ] Click holes - should now select
-   [ ] Deactivate Select Pointer tool
-   [ ] Click holes - should NOT select

### QUIRK 3 - Tool Mutual Exclusion

-   [ ] Activate Select Pointer tool
-   [ ] Verify it's checked/active
-   [ ] Activate Select Polygon tool
-   [ ] Verify Select Pointer is now unchecked
-   [ ] Verify Select Polygon is checked
-   [ ] Verify any existing selections remain (not cleared)
-   [ ] Activate Select Pointer again
-   [ ] Verify Select Polygon is now unchecked
-   [ ] Verify Select Pointer is checked

### Undeclared Variable

-   [ ] Open browser console
-   [ ] Verify no "assignment to undeclared variable isAddKADPointsToolActive" error
-   [ ] Switch between various tools
-   [ ] Verify no console errors

---

## Files Modified

1. `src/kirra.js`
    - Line ~567: Added animation loop start on CameraControls init
    - Line ~877: Added tool activation check in handle3DClick
    - Line ~2873: Fixed variable name typo
    - Line ~25023: Added 3D polygon disable in selectPointerTool
    - Line ~26317: Added SelectPointer disable in selectByPolygonTool (3D mode)

---

## Notes

-   All fixes maintain existing selections when tools are toggled (per user requirements)
-   Connector tools (single and multi) bypass the tool activation check since they have their own activation logic
-   Animation loop runs continuously in 3D mode for smooth rendering
-   2D mode is unaffected by these changes
